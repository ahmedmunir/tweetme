{% extends 'pages/base.html' %}

<!-- Home Title -->
{% block title %}
    {% if user.is_authenticated %}
        Home - @{{ user.username }}
    {% else %}
        TweeTME - Home
    {% endif %}
{% endblock title %}

<!-- Home static -->
{% load static %}
{% block extraStyle %}
    <link rel="stylesheet" href="{% static 'pages/home.css' %}">
{% endblock extraStyle %}

{% block content %}
    <div class="search_box">
        <input type="text" placeholder="search" name="search" class="search_input_tag">
        <button class='btn btn-primary search'>Search</button>
        <p class='wrong-alert'></p>
    </div>
    {% if user.is_authenticated %}
        <form method="POST" action="{% url 'tweet-create' %}">
            {% csrf_token %}
            <textarea name="content" id="id_content" placeholder="What is happening?"></textarea>
            <button type="submit" class="btn btn-primary create_tweet" disabled>tweet</button>
            <div class="line_break"></div>
        </form>
    {% endif %}

    <div id="tweets" class='panel-body'></div>
{% endblock content %}

{% block extraScript %}
    <script>
        /*
            =========
            Variables
            =========
        */
        let tweetsElement = document.querySelector("#tweets");
        let scrolled = false;
        var start = 0

        /*
            ================
            Event Listeners
            ================
        */

        // Disable Button Tweet while Characters are 0 or more than 250
        // Ensure that user is already logged in to add event listener
        if(document.querySelector('#id_content')){
            document.querySelector('#id_content').addEventListener('keyup', e => {
                if(e.target.value.length > 250 || e.target.value.length == 0){
                    document.querySelector('.create_tweet').setAttribute('disabled', true);
                } else {
                    document.querySelector('.create_tweet').removeAttribute('disabled');
                }
            })
        }

        // Loading more data when reaching to the end of page
        window.addEventListener('scroll', e => {
            if(window.scrollY + window.innerHeight >= document.body.offsetHeight) {
                
                // load more data from server
                if(scrolled == false) {
                    fetchData();
                    scrolled = true;
                    
                }
            }
        })

        // Add new Tweet AJAX request
        // Ensure that user is already logged in to add event listener
        if(document.querySelector('.create_tweet')){
            document.querySelector('.create_tweet').addEventListener('click', e => {
                e.preventDefault();
                
                let url = `${window.location.protocol}//${window.location.hostname}:${window.location.port}/tweets/create/`
                let tweet_content = new FormData()
                tweet_content.append('content', document.querySelector('#id_content').value);
                
                // Send new TweeT request
                fetch(url, {
                    method: "POST",
                    body: tweet_content,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {

                    // Append new tweet if it was successful
                    if(data['process'] == 'success') {
                        
                        add_tweet_to_dom('afterbegin', data['tweet']);
                        document.querySelector('#id_content').value = '';

                    } else if(data['process'] == 'failed') {
                        document.querySelector('.wrong-alert').innerHTML = data['errors']['content'][0];
                    }
                })
            })
        }

        /*
        ==============
            Functions
        ==============
        */

        //GET CSRF Token
        const getCookie =  name =>  {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        //Display loading Icon
        const loadingIcon = (state) => {
            if(state=="hide"){
                document.querySelector('.loading_icon').remove();
            }
            else if(state="show"){
                let icon = document.createElement('h2');
                icon.classList.add('loading_icon');
                icon.innerHTML = "Loading..........";
                tweetsElement.insertAdjacentElement('beforeend', icon);
            }
        }

        // REACT tweet function
        const react_tweet = (react_button) => {
            react_button.addEventListener('click', e => {
                e.preventDefault();

                let id = e.target.closest('.tweet_container').dataset.id;
                let url = `${window.location.protocol}//${window.location.hostname}:${window.location.port}/tweets/${id}/react/`;
                let react = e.target.closest('a').dataset['react']
                let data = new FormData()
                data.append('react', react);

                // Send request
                fetch(url, {
                    method: "POST",
                    body: data,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    console.log(response)
                    if(response.redirected == true){
                        document.querySelector('.wrong-alert').innerHTML = "You need to login first to be able to react to TweeTs!";
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    // If tweet deleted before we react
                    if(data['message']) {
                        document.querySelector('.wrong-alert').innerHTML = data['message'];
                    } else {

                        // Change link button state
                        e.target.closest('.text_username_container').childNodes[4].classList[data['like']]('react_color');
                        
                        // change number of likes
                        e.target.closest('.text_username_container').childNodes[5].innerHTML = data['likes'];
                        
                        // change dislike button state
                        e.target.closest('.text_username_container').childNodes[6].classList[data['dislike']]('react_color');
                        
                        // change number of dislikes
                        e.target.closest('.text_username_container').childNodes[7].innerHTML = data['dislikes'];
                    }
                })
            })
        }

        // DELETE Function 
        const delete_event_listener = (delete_button) => {
            delete_button.addEventListener('click', e => {
                e.preventDefault();
                let id = e.target.closest('.tweet_container').dataset.id;
                let url = `${window.location.protocol}//${window.location.hostname}:${window.location.port}/tweets/${id}/delete/`;

                fetch(url, {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if(data['message'] == 'TweeT deleted successfully!'){
                        e.target.closest('.tweet_container').remove();
                        document.querySelector('.wrong-alert').innerHTML = data['message'];
                    } else {
                        document.querySelector('.wrong-alert').innerHTML = data['message'];
                    }
                })
            })
        }

        // Fetch Tweets from server
        const fetchData = () => {

            // Display Loading Icon while waiting to Fetch data from back-end
            loadingIcon('show');

            let params = new URLSearchParams({
                'start' : start,
            })

            // Fetch data from server
            let url = `${window.location.protocol}//${window.location.hostname}:${window.location.port}/tweets/?${params}`
            fetch(url, {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                
                // Hide Loading shape
                loadingIcon('hide');

                if(data['tweets'].length > 0){

                    // Display tweets
                    data['tweets'].forEach(tweet => {

                        //Add new Tweet
                        add_tweet_to_dom('beforeend', tweet);

                        //set start to new value
                        start = data['start'];

                        //set scrolled to false again
                        scrolled = false;
                        
                    });
                } else {
                    let tweets_end = document.createElement('small');
                    tweets_end.classList.add('tweets_end');
                    tweets_end.innerHTML = "There are no more tweets to load";
                    tweetsElement.insertAdjacentElement('beforeend', tweets_end);
                }
            })
        }

        // create new tweet function
        const add_tweet_to_dom = (position, tweet) => {

            // Tweet Element Container
            let tweet_Element = document.createElement('div');
            tweet_Element.classList.add('row');
            tweet_Element.classList.add('tweet_container');
            tweet_Element.setAttribute('data-id', tweet['id']);
            

            // Tweet text & username container
            let tweet_text_username = document.createElement('div');
            tweet_text_username.classList.add('col-md-11')
            tweet_text_username.classList.add('text_username_container');

            // Tweet username
            let tweet_username = document.createElement('a');
            tweet_username.classList.add('tweet_username');
            tweet_username.setAttribute('href', "#");
            tweet_username.innerHTML = `${tweet['user_first_name']} ${tweet['user_last_name']}`;

            // Tweet user unique name
            let tweet_unique_user = document.createElement('small');
            tweet_unique_user.classList.add('tweet_user_unique');
            tweet_unique_user.innerHTML = ` @${tweet['user_username']}`;

            // Tweet Date
            let tweet_date = document.createElement('small');
            tweet_date.classList.add('tweet_date');
            tweet_date.innerHTML = tweet['date_posted'];

            // Tweet Text
            let tweet_text = document.createElement('p');
            tweet_text.classList.add('tweet_text');
            tweet_text.innerHTML = tweet['content'];

            // Tweet Like button
            let like_button = document.createElement('a');
            like_button.classList.add('like_button');
            like_button.classList[tweet['liked']]('react_color');
            like_button.setAttribute('data-react', 'like');
            like_button.innerHTML = '<i class="fa fa-thumbs-up"></i>';
            react_tweet(like_button);

            // Number of likes
            let likes_number = document.createElement('span');
            likes_number.classList.add('likes_number');
            likes_number.innerHTML = tweet['likes'];

            // Tweet Dislike button
            let dislike_button = document.createElement('a');
            dislike_button.classList.add('dislike_button');
            dislike_button.classList[tweet['disliked']]('react_color');
            dislike_button.setAttribute('data-react', 'dislike');
            dislike_button.innerHTML = '<i class="fa fa-thumbs-down"></i>';
            react_tweet(dislike_button);

            // Number of Dislikes
            let dislikes_number = document.createElement('span');
            dislikes_number.classList.add('dislikes_number');
            dislikes_number.innerHTML = tweet['dislikes'];

            // Delete button
            if(tweet['tweet-owner'] === true) {
                var delete_button = document.createElement('a');
                delete_button.classList.add('delete_tweet');
                delete_button.innerHTML = '<i class="fa fa-trash"></i>';

                // Add event listener to new DELETE Button
                delete_event_listener(delete_button);
            }

            // User image container
            let user_image = document.createElement('div');
            user_image.classList.add('col-md-1');
            user_image.classList.add('image_container');
            let image_url = tweet['user_image'];
            let image = document.createElement('img');
            image.classList.add('user_tweet_image');
            image.setAttribute('src', image_url);
            user_image.insertAdjacentElement('afterbegin', image);

            // Insert All elements inside Div that will contain them
            tweet_text_username.insertAdjacentElement('beforeend', tweet_username);
            tweet_text_username.insertAdjacentElement('beforeend', tweet_unique_user);
            tweet_text_username.insertAdjacentElement('beforeend', tweet_date);
            tweet_text_username.insertAdjacentElement('beforeend', tweet_text);
            tweet_text_username.insertAdjacentElement('beforeend', like_button);
            tweet_text_username.insertAdjacentElement('beforeend', likes_number);
            tweet_text_username.insertAdjacentElement('beforeend', dislike_button);
            tweet_text_username.insertAdjacentElement('beforeend', dislikes_number);

            // Display Delete button if exists
            if(delete_button){
                tweet_text_username.insertAdjacentElement('beforeend', delete_button);
            }
            
            tweet_Element.insertAdjacentElement('beforeend', user_image);
            tweet_Element.insertAdjacentElement('beforeend', tweet_text_username);
            tweetsElement.insertAdjacentElement(position, tweet_Element);

            
        }

        fetchData();
    </script>

{% endblock extraScript %}
